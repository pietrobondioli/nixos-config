#!/usr/bin/env bash

# Toggle screen recording with wf-recorder (software encoding fallback)
PIDFILE="/tmp/screenrec-wf.pid"

# Source logging utility
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/logger.sh"

if [ -f "$PIDFILE" ]; then
  # Stop recording
  PID=$(cat "$PIDFILE")
  log_info "Stopping recording (PID: $PID)"
  if kill -0 "$PID" 2>/dev/null; then
    kill -INT "$PID"
    wait "$PID" 2>/dev/null
    log_info "Recording stopped successfully"
  else
    log_warn "Process $PID not found, cleaning up stale PID file"
  fi
  rm "$PIDFILE"
  notify-send "Recording stopped" "Video saved to ~/Videos/"
else
  # Choose recording mode
  MODE=$(echo -e "Select Area\nFull Screen" | rofi -dmenu -p "Recording Mode")
  [ -z "$MODE" ] && exit 0

  # Choose audio
  AUDIO=$(echo -e "With Audio\nNo Audio" | rofi -dmenu -p "Audio")
  [ -z "$AUDIO" ] && exit 0

  # Set audio args
  if [ "$AUDIO" = "With Audio" ]; then
    AUDIO_ARGS=("--audio")
  else
    AUDIO_ARGS=()
  fi

  # Set geometry args
  if [ "$MODE" = "Select Area" ]; then
    GEOMETRY=$(slurp)
    [ -z "$GEOMETRY" ] && exit 0

    # Validate geometry format (should be "x,y WxH")
    if ! echo "$GEOMETRY" | grep -qE '^[0-9]+,[0-9]+ [0-9]+x[0-9]+$'; then
      notify-send "Recording cancelled" "Invalid region selected. Please drag to select an area, don't just click."
      exit 1
    fi

    # Check if geometry has zero width or height
    WIDTH=$(echo "$GEOMETRY" | awk '{print $2}' | cut -d'x' -f1)
    HEIGHT=$(echo "$GEOMETRY" | awk '{print $2}' | cut -d'x' -f2)
    if [ "$WIDTH" -eq 0 ] || [ "$HEIGHT" -eq 0 ]; then
      notify-send "Recording cancelled" "Selected region has zero size (${WIDTH}x${HEIGHT})"
      exit 1
    fi

    # Round dimensions to even numbers (required by libx264)
    WIDTH=$((WIDTH - (WIDTH % 2)))
    HEIGHT=$((HEIGHT - (HEIGHT % 2)))

    # Extract position and reconstruct geometry with even dimensions
    POSITION=$(echo "$GEOMETRY" | awk '{print $1}')
    GEOMETRY="${POSITION} ${WIDTH}x${HEIGHT}"

    GEOMETRY_ARGS=("-g" "$GEOMETRY")
    OUTPUT_ARGS=()
  else
    # Get the currently focused output for full screen recording
    FOCUSED_OUTPUT=$(niri msg -j focused-output | grep -o '"name":"[^"]*"' | cut -d'"' -f4)
    if [ -z "$FOCUSED_OUTPUT" ]; then
      notify-send "Recording failed" "Could not detect focused output"
      exit 1
    fi
    GEOMETRY_ARGS=()
    OUTPUT_ARGS=("-o" "$FOCUSED_OUTPUT")
  fi

  # Start recording with wf-recorder using software encoding
  OUTPUT_FILE="$HOME/Videos/recording-$(date +%Y%m%d-%H%M%S).mp4"
  log_info "Starting recording: mode=$MODE, audio=$AUDIO, output=$OUTPUT_FILE"
  [ -n "${GEOMETRY_ARGS[*]}" ] && log_debug "Geometry: ${GEOMETRY_ARGS[*]}"
  [ -n "${OUTPUT_ARGS[*]}" ] && log_debug "Output: ${OUTPUT_ARGS[*]}"

  # Use libx264 software encoder to avoid VAAPI/NVIDIA issues
  wf-recorder -c libx264 "${GEOMETRY_ARGS[@]}" "${OUTPUT_ARGS[@]}" "${AUDIO_ARGS[@]}" -f "$OUTPUT_FILE" >>"$LOG_FILE" 2>&1 &
  REC_PID=$!

  # Wait briefly to check if wf-recorder started successfully
  sleep 0.5
  if kill -0 "$REC_PID" 2>/dev/null; then
    echo "$REC_PID" >"$PIDFILE"
    log_info "Recording started successfully (PID: $REC_PID)"
    notify-send "Recording started" "Press keybind again to stop"
  else
    log_error "wf-recorder failed to start"
    notify-send "Recording failed" "wf-recorder failed to start. Check logs: tail /tmp/record-area-wf.log"
    exit 1
  fi
fi
