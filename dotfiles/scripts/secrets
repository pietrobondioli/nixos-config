#!/usr/bin/zsh

# Discover command locations at script start
OP_CMD=$(command -v op)

# Validate required commands exist
if [[ -z "$OP_CMD" ]]; then
    echo "‚ùå ERROR: 1Password CLI (op) is not installed or not in PATH." >&2
    echo "   Install from: https://developer.1password.com/docs/cli/get-started/" >&2
    return 1
fi

load_secrets() {
    echo "üîë Checking 1Password connection..."

    if ! "$OP_CMD" whoami >/dev/null 2>&1; then
        echo "   Running op signin..."
        "$OP_CMD" signin < /dev/tty

        if ! "$OP_CMD" whoami >/dev/null 2>&1; then
            echo "‚ùå ERROR: Signin failed. Please check your credentials." >&2
            return 1
        fi
    fi

    echo "‚è≥ Loading secrets..."
    eval "$("$OP_CMD" inject -i <(cat <<'EOF'
export GITHUB_TOKEN="{{ op://Personal/pietro-pc-github-token/token }}"
export GITHUB_REGISTRY_AUTH_TOKEN="{{ op://Personal/pietro-pc-github-token/token }}"
export FONT_AWESOME_TOKEN="{{ op://Personal/syniti-fort-awesome-token/token }}"
export NEXUS_USERNAME="{{ op://Personal/syniti-nexus/username }}"
export NEXUS_PASSWORD="{{ op://Personal/syniti-nexus/password }}"
export NEXUS_DOTNET_SOURCE="{{ op://Personal/syniti-nexus/dotnet-source }}"
export SKP_DOTNET_SOURCE="{{ op://Personal/syniti-skp-nuget/dotnet-source }}"
export GOPRIVATE="{{ op://Private/go-private-repos/pattern }}"
EOF
))"

    echo "‚ú® All secrets loaded."
}
