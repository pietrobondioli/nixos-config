#!/usr/bin/env bash

# Advanced screen recording with area selection
PIDFILE="/tmp/wf-recorder.pid"

if [ -f "$PIDFILE" ]; then
    # Stop recording
    PID=$(cat "$PIDFILE")
    if kill -0 "$PID" 2>/dev/null; then
        kill -INT "$PID"
        wait "$PID" 2>/dev/null
    fi
    rm "$PIDFILE"
    notify-send "Recording stopped" "Video saved to ~/Videos/"
else
    # Choose audio source
    AUDIO_CHOICE=$(echo -e "Desktop Audio\nNo Audio" | rofi -dmenu -p "Audio Source")
    
    case "$AUDIO_CHOICE" in
        "Desktop Audio")
            AUDIO_ARGS="-a"
            ;;
        "No Audio")
            AUDIO_ARGS=""
            ;;
        *)
            exit 0
            ;;
    esac
    
    # Select area
    GEOMETRY=$(slurp)
    if [ -n "$GEOMETRY" ]; then
        OUTPUT_FILE="$HOME/Videos/recording-$(date +%Y%m%d-%H%M%S).mp4"
        wf-recorder -g "$GEOMETRY" $AUDIO_ARGS -f "$OUTPUT_FILE" &
        echo $! > "$PIDFILE"
        notify-send "Recording started" "Press keybind again to stop"
    fi
fi
